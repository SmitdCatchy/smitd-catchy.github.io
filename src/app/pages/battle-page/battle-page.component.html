<smitd-header>

  <button mat-icon-button (click)="back()">
    <mat-icon>chevron_left</mat-icon>
  </button>

  <h2>{{warband.name | translate}}</h2>

  <button mat-icon-button [matMenuTriggerFor]="main">
    <mat-icon>menu</mat-icon>
  </button>

  <mat-menu #main="matMenu">
    <button mat-menu-item *ngIf="warband.abilities.length"
      (click)="warbandService.showAbilities(warband.abilities, undefined, warband, false, true)">{{'battle-page.menu.warband' | translate}}</button>
    <button mat-menu-item *ngIf="battleService.battle.battleState === BattleState.Roster"
      (click)="battleService.beginBattle()">{{'battle-page.menu.begin' | translate}}</button>
    <button mat-menu-item *ngIf="battleService.battle.battleState === BattleState.Battle"
      (click)="battleService.endTurn()">{{'battle-page.menu.turn' | translate}}</button>
    <button mat-menu-item *ngIf="battleService.battle.battleState === BattleState.Battle"
      (click)="battleService.endBattle()">{{'battle-page.menu.end' | translate}}</button>
    <button mat-menu-item *ngIf="battleService.battle.battleState === BattleState.Roster"
      (click)="battleService.addFighter()">{{'battle-page.menu.fighter' | translate}}</button>
    <button mat-menu-item *ngIf="battleService.battle.battleState === BattleState.Battle"
      (click)="battleService.addWildFighter()">{{'battle-page.menu.wild' | translate}}</button>
    <button mat-menu-item (click)="battleService.abortBattle()">{{'battle-page.menu.abort' | translate}}</button>
  </mat-menu>
</smitd-header>
<mat-card class="score">
  <ng-container [ngSwitch]="battleService.battle.battleState">
    <ng-container *ngSwitchCase="BattleState.Roster">
      <h2>{{'' | translate}}{{battleService.warbandSize}} /
        {{'' | translate}}{{battleService.battle.warband.campaign.limit}} <span>{{'PTS'}}</span></h2>
    </ng-container>
    <ng-container *ngSwitchCase="BattleState.Battle">
      <div class="stats">
        <h2>{{'battle-page.battle.turn' | translate}}: <b> {{battle.turn}}</b></h2>
        <div class="victory">
          <button mat-icon-button aria-label="subtract" [disabled]="battle.victoryPoints - 1 < 0"
            (click)="alterVictoryPoints(-1)">
            <mat-icon>remove</mat-icon>
          </button>
          <h2>{{'battle-page.battle.victory-points' | translate}}: <b> {{battle.victoryPoints}}</b></h2>
          <button mat-icon-button aria-label="add" (click)="alterVictoryPoints(1)">
            <mat-icon>add</mat-icon>
          </button>
        </div>
      </div>
    </ng-container>
    <ng-container *ngSwitchDefault>
    </ng-container>
  </ng-container>
</mat-card>
<mat-tab-group color="primary" mat-stretch-tabs dynamicHeight [selectedIndex]="battle.battleState">
  <mat-tab>
    <div class="prepare">
      <div class="boundary">
        <div class="divider">
          <mat-divider></mat-divider>
          <span class="label">{{'battle-page.group.dagger' | translate}}</span>
          <mat-divider></mat-divider>
        </div>
        <div class="fighters dagger" cdkDropList #daggerList="cdkDropList"
          [cdkDropListData]="battleService.battle.dagger"
          [cdkDropListConnectedTo]="[rosterList, hammerList, shieldList]"
          (cdkDropListDropped)="battleService.moveFighter($event)">
          <smitd-fighter-card [fighter]="fighter.stats" [fighterReference]="fighter" [mode]="FighterCardMode.list"
            (callAbilities)="warbandService.showAbilities(warband.abilities, fighter.stats)"
            *ngFor="let fighter of battleService.battle.dagger; let index = index" cdkDrag cdkDragBoundary=".boundary">
            <div class="drag-marker" cdkDragHandle></div>
            <div class="options" options>
            </div>
          </smitd-fighter-card>
        </div>
        <div class="divider">
          <mat-divider></mat-divider>
          <span class="label">{{'battle-page.group.shield' | translate}}</span>
          <mat-divider></mat-divider>
        </div>
        <div class="fighters shield" cdkDropList #shieldList="cdkDropList"
          [cdkDropListData]="battleService.battle.shield"
          [cdkDropListConnectedTo]="[rosterList, hammerList, daggerList]"
          (cdkDropListDropped)="battleService.moveFighter($event)">
          <smitd-fighter-card [fighter]="fighter.stats" [fighterReference]="fighter" [mode]="FighterCardMode.list"
            (callAbilities)="warbandService.showAbilities(warband.abilities, fighter.stats)"
            *ngFor="let fighter of battleService.battle.shield; let index = index" cdkDrag cdkDragBoundary=".boundary">
            <div class="drag-marker" cdkDragHandle></div>
            <div class="options" options>
            </div>
          </smitd-fighter-card>
        </div>
        <div class="divider">
          <mat-divider></mat-divider>
          <span class="label">{{'battle-page.group.hammer' | translate}}</span>
          <mat-divider></mat-divider>
        </div>
        <div class="fighters hammer" cdkDropList #hammerList="cdkDropList"
          [cdkDropListData]="battleService.battle.hammer"
          [cdkDropListConnectedTo]="[rosterList, shieldList, daggerList]"
          (cdkDropListDropped)="battleService.moveFighter($event)">
          <smitd-fighter-card [fighter]="fighter.stats" [fighterReference]="fighter" [mode]="FighterCardMode.list"
            (callAbilities)="warbandService.showAbilities(warband.abilities, fighter.stats)"
            *ngFor="let fighter of battleService.battle.hammer; let index = index" cdkDrag cdkDragBoundary=".boundary">
            <div class="drag-marker" cdkDragHandle></div>
            <div class="options" options>
            </div>
          </smitd-fighter-card>
        </div>
        <div class="divider">
          <mat-divider></mat-divider>
          <span class="label">{{'Roster'}}</span>
          <mat-divider></mat-divider>
        </div>
        <div class="fighters roster" cdkDropList #rosterList="cdkDropList"
          [cdkDropListData]="battleService.battle.roster"
          [cdkDropListConnectedTo]="[hammerList, shieldList, daggerList]"
          (cdkDropListDropped)="battleService.moveFighter($event)">
          <smitd-fighter-card [fighter]="fighter.stats" [fighterReference]="fighter" [mode]="FighterCardMode.list"
            (callAbilities)="warbandService.showAbilities(warband.abilities, fighter.stats)"
            *ngFor="let fighter of battleService.battle.roster; let index = index" cdkDrag cdkDragBoundary=".boundary">
            <div class="drag-marker" cdkDragHandle></div>
            <div class="options" options>
            </div>
          </smitd-fighter-card>
        </div>
      </div>
    </div>
  </mat-tab>
  <mat-tab>
    <div class="battle">
      <div class="divider" *ngIf="battleService.battle.shield.length">
        <mat-divider></mat-divider>
        <span class="label">{{'battle-page.group.dagger' | translate}}</span>
        <mat-divider></mat-divider>
      </div>
      <div class="fighters dagger">
        <smitd-fighter-card [fighter]="fighter.stats" [fighterReference]="fighter" [mode]="FighterCardMode.battle"
          (callAbilities)="warbandService.showAbilities(warband.abilities, fighter.stats, undefined, true)"
          *ngFor="let fighter of battleService.battle.dagger; let index = index">
          <div class="options" options>
            <div class="options" options>
              <div class="divider">
                <mat-divider></mat-divider>
                <span>{{'common.options' | translate}}</span>
                <mat-divider></mat-divider>
              </div>
              <mat-form-field appearance="fill">
                <mat-label>{{'battle-page.options.notes' | translate}}</mat-label>
                <textarea matInput [rows]="4"></textarea>
              </mat-form-field>
            </div>
          </div>
          <div class="battleframe-header" battleframeHeader>
            <div class="fighter-state" matRipple *ngIf="fighter.state">
              <div class="state" (click)="stateSelection.toggle()">
                <img [src]="'assets/runemarks/fighter-state-' + fighter.state + '.svg'"
                  [alt]="'fighter-card.characteristic.movement' | translate" class="runemark invert">
              </div>
              <mat-select #stateSelection [(value)]="fighter.state" (valueChange)="battleService.saveBattle()"
                [disabled]="fighter.state === FighterState.Dead">
                <mat-option [value]="FighterState.Ready">{{'fighter-state.' + FighterState.Ready | translate}}
                </mat-option>
                <mat-option [value]="FighterState.Waiting">{{'fighter-state.' + FighterState.Waiting | translate}}
                </mat-option>
                <mat-option [value]="FighterState.Reacted">{{'fighter-state.' + FighterState.Reacted | translate}}
                </mat-option>
                <mat-option [value]="FighterState.Activated">{{'fighter-state.' + FighterState.Activated | translate}}
                </mat-option>
              </mat-select>
            </div>
            <div class="wound-counter">
              <div class="value">{{fighter.wounds}}</div>
              <button mat-icon-button aria-label="add wounds" [disabled]="fighter.wounds + 1 > fighter.stats.wounds"
                (click)="alterWounds(fighter, 1)">
                <mat-icon>keyboard_arrow_up</mat-icon>
              </button>
              <button mat-icon-button aria-label="subtract wounds" [disabled]="fighter.wounds - 1 < 0"
                (click)="alterWounds(fighter, -1)">
                <mat-icon>keyboard_arrow_down</mat-icon>
              </button>
            </div>
          </div>
        </smitd-fighter-card>
      </div>
      <div class="divider" *ngIf="battleService.battle.shield.length">
        <mat-divider></mat-divider>
        <span class="label">{{'battle-page.group.shield' | translate}}</span>
        <mat-divider></mat-divider>
      </div>
      <div class="fighters shield" *ngIf="battleService.battle.shield.length">
        <smitd-fighter-card [fighter]="fighter.stats" [fighterReference]="fighter" [mode]="FighterCardMode.battle"
          (callAbilities)="warbandService.showAbilities(warband.abilities, fighter.stats, undefined, true)"
          *ngFor="let fighter of battleService.battle.shield; let index = index">
          <div class="options" options>
            <div class="options" options>
              <div class="divider">
                <mat-divider></mat-divider>
                <span>{{'common.options' | translate}}</span>
                <mat-divider></mat-divider>
              </div>
              <mat-form-field appearance="fill">
                <mat-label>{{'battle-page.options.notes' | translate}}</mat-label>
                <textarea matInput [rows]="4"></textarea>
              </mat-form-field>
            </div>
          </div>
          <div class="battleframe-header" battleframeHeader>
            <div class="fighter-state" matRipple *ngIf="fighter.state">
              <div class="state" (click)="stateSelection.toggle()">
                <img [src]="'assets/runemarks/fighter-state-' + fighter.state + '.svg'"
                  [alt]="'fighter-card.characteristic.movement' | translate" class="runemark invert">
              </div>
              <mat-select #stateSelection [(value)]="fighter.state" (valueChange)="battleService.saveBattle()"
                [disabled]="fighter.state === FighterState.Dead">
                <mat-option [value]="FighterState.Ready">{{'fighter-state.' + FighterState.Ready | translate}}
                </mat-option>
                <mat-option [value]="FighterState.Waiting">{{'fighter-state.' + FighterState.Waiting | translate}}
                </mat-option>
                <mat-option [value]="FighterState.Reacted">{{'fighter-state.' + FighterState.Reacted | translate}}
                </mat-option>
                <mat-option [value]="FighterState.Activated">{{'fighter-state.' + FighterState.Activated | translate}}
                </mat-option>
              </mat-select>
            </div>
            <div class="wound-counter">
              <div class="value">{{fighter.wounds}}</div>
              <button mat-icon-button aria-label="add wounds" [disabled]="fighter.wounds + 1 > fighter.stats.wounds"
                (click)="alterWounds(fighter, 1)">
                <mat-icon>keyboard_arrow_up</mat-icon>
              </button>
              <button mat-icon-button aria-label="subtract wounds" [disabled]="fighter.wounds - 1 < 0"
                (click)="alterWounds(fighter, -1)">
                <mat-icon>keyboard_arrow_down</mat-icon>
              </button>
            </div>
          </div>
        </smitd-fighter-card>
      </div>
      <div class="divider" *ngIf="battleService.battle.hammer.length">
        <mat-divider></mat-divider>
        <span class="label">{{'battle-page.group.hammer' | translate}}</span>
        <mat-divider></mat-divider>
      </div>
      <div class="fighters hammer" *ngIf="battleService.battle.hammer.length">
        <smitd-fighter-card [fighter]="fighter.stats" [fighterReference]="fighter" [mode]="FighterCardMode.battle"
          (callAbilities)="warbandService.showAbilities(warband.abilities, fighter.stats, undefined, true)"
          *ngFor="let fighter of battleService.battle.hammer; let index = index">
          <div class="options" options>
            <div class="options" options>
              <div class="divider">
                <mat-divider></mat-divider>
                <span>{{'common.options' | translate}}</span>
                <mat-divider></mat-divider>
              </div>
              <mat-form-field appearance="fill">
                <mat-label>{{'battle-page.options.notes' | translate}}</mat-label>
                <textarea matInput [rows]="4"></textarea>
              </mat-form-field>
            </div>
          </div>
          <div class="battleframe-header" battleframeHeader>
            <div class="fighter-state" matRipple *ngIf="fighter.state">
              <div class="state" (click)="stateSelection.toggle()">
                <img [src]="'assets/runemarks/fighter-state-' + fighter.state + '.svg'"
                  [alt]="'fighter-card.characteristic.movement' | translate" class="runemark invert">
              </div>
              <mat-select #stateSelection [(value)]="fighter.state" (valueChange)="battleService.saveBattle()"
                [disabled]="fighter.state === FighterState.Dead">
                <mat-option [value]="FighterState.Ready">{{'fighter-state.' + FighterState.Ready | translate}}
                </mat-option>
                <mat-option [value]="FighterState.Waiting">{{'fighter-state.' + FighterState.Waiting | translate}}
                </mat-option>
                <mat-option [value]="FighterState.Reacted">{{'fighter-state.' + FighterState.Reacted | translate}}
                </mat-option>
                <mat-option [value]="FighterState.Activated">{{'fighter-state.' + FighterState.Activated | translate}}
                </mat-option>
              </mat-select>
            </div>
            <div class="wound-counter">
              <div class="value">{{fighter.wounds}}</div>
              <button mat-icon-button aria-label="add wounds" [disabled]="fighter.wounds + 1 > fighter.stats.wounds"
                (click)="alterWounds(fighter, 1)">
                <mat-icon>keyboard_arrow_up</mat-icon>
              </button>
              <button mat-icon-button aria-label="subtract wounds" [disabled]="fighter.wounds - 1 < 0"
                (click)="alterWounds(fighter, -1)">
                <mat-icon>keyboard_arrow_down</mat-icon>
              </button>
            </div>
          </div>
        </smitd-fighter-card>
      </div>
      <div class="divider" *ngIf="battleService.battle.wild.length">
        <mat-divider></mat-divider>
        <span class="label">{{'battle-page.group.wild' | translate}}</span>
        <mat-divider></mat-divider>
      </div>
      <div class="fighters wild" *ngIf="battleService.battle.wild.length">
        <smitd-fighter-card [fighter]="fighter.stats" [fighterReference]="fighter" [mode]="FighterCardMode.battle"
          (callAbilities)="warbandService.showAbilities([], fighter.stats, undefined, true)"
          *ngFor="let fighter of battleService.battle.wild; let index = index">
          <div class="options" options>
            <div class="options" options>
              <div class="divider">
                <mat-divider></mat-divider>
                <span>{{'common.options' | translate}}</span>
                <mat-divider></mat-divider>
              </div>
              <mat-form-field appearance="fill">
                <mat-label>{{'battle-page.options.notes' | translate}}</mat-label>
                <textarea matInput [rows]="4"></textarea>
              </mat-form-field>
            </div>
            <div class="divider">
              <mat-divider></mat-divider>
              <span>{{'common.options' | translate}}</span>
              <mat-divider></mat-divider>
            </div>
            <div class="actions wild">
              <button mat-flat-button color="warn"
                (click)="battleService.removeWildFighter(index)">{{'battle-page.battle.remove-wild' | translate}}</button>
            </div>
          </div>
          <div class="battleframe-header" battleframeHeader>
            <div class="fighter-state" matRipple *ngIf="fighter.state">
              <div class="state" (click)="stateSelection.toggle()">
                <img [src]="'assets/runemarks/fighter-state-' + fighter.state + '.svg'"
                  [alt]="'fighter-card.characteristic.movement' | translate" class="runemark invert">
              </div>
              <mat-select #stateSelection [(value)]="fighter.state" (valueChange)="battleService.saveBattle()"
                [disabled]="fighter.state === FighterState.Dead">
                <mat-option [value]="FighterState.Ready">{{'fighter-state.' + FighterState.Ready | translate}}
                </mat-option>
                <mat-option [value]="FighterState.Waiting">{{'fighter-state.' + FighterState.Waiting | translate}}
                </mat-option>
                <mat-option [value]="FighterState.Reacted">{{'fighter-state.' + FighterState.Reacted | translate}}
                </mat-option>
                <mat-option [value]="FighterState.Activated">{{'fighter-state.' + FighterState.Activated | translate}}
                </mat-option>
              </mat-select>
            </div>
            <div class="wound-counter">
              <div class="value">{{fighter.wounds}}</div>
              <button mat-icon-button aria-label="add wounds" [disabled]="fighter.wounds + 1 > fighter.stats.wounds"
                (click)="alterWounds(fighter, 1)">
                <mat-icon>keyboard_arrow_up</mat-icon>
              </button>
              <button mat-icon-button aria-label="subtract wounds" [disabled]="fighter.wounds - 1 < 0"
                (click)="alterWounds(fighter, -1)">
                <mat-icon>keyboard_arrow_down</mat-icon>
              </button>
            </div>
          </div>
        </smitd-fighter-card>
      </div>
    </div>
  </mat-tab>
</mat-tab-group>
